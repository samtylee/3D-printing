<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Stall App - TEST</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #667eea; min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px 20px; text-align: center; color: white; }
        .header h1 { font-size: 2.5em; margin-bottom: 5px; }
        .sync-indicator { margin-top: 15px; font-size: 0.9em; }
        .sync-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #4caf50; margin-right: 8px; }
        .sync-dot.offline { background: #ff9800; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #ddd; }
        .tab-button { flex: 1; padding: 15px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 500; transition: 0.3s; }
        .tab-button.active { background: white; border-bottom: 3px solid #667eea; color: #667eea; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .section-box { margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 5px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #f5576c; color: white; }
        input { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; }
        .team-list { margin: 10px 0; padding: 10px; background: white; border-radius: 3px; min-height: 30px; }
        .team-member { background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }
        .mode-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 10px 15px; border: 2px solid #ddd; background: white; cursor: pointer; border-radius: 5px; font-weight: 500; transition: 0.3s; }
        .mode-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .sales-mode { display: none; }
        .sales-mode.active { display: block; }
        .quick-sale-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .product-btn { padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .product-btn:hover { background: #5568d3; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal.hidden { display: none !important; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; text-align: center; min-width: 300px; }
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: 500; }
        select { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; }
        textarea { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; width: 100%; font-family: Arial; }
        .qty-buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; }
        /* Dashboard & report extras */
        .progress-container { background:#eee; border-radius:8px; height:18px; overflow:hidden; margin-top:8px; }
        .progress-bar { height:100%; background: linear-gradient(90deg,#67d3b8,#667eea); width:0%; transition: width 600ms ease; }
        .top-seller { padding:8px 10px; border-radius:6px; background:#fff8e1; display:inline-block; font-weight:700; }
        .badge-animate { animation: pulse 900ms ease; }
        @keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)} }
        .confetti-canvas { position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:1200; }
        .notification { position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 2000; font-weight: bold; animation: slideIn 300ms ease; }
        /* Report styling */
        .report-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .report-header h3 { font-size: 1.8em; margin-bottom: 5px; }
        .report-header p { margin: 5px 0; font-size: 0.95em; opacity: 0.95; }
        .report-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .metric-card { background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .metric-card .label { font-size: 0.85em; color: #666; font-weight: 500; margin-bottom: 5px; }
        .metric-card .value { font-size: 1.8em; color: #667eea; font-weight: bold; }
        .metric-card.profit .value { color: #4caf50; }
        .metric-card.costs .value { color: #ff9800; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
    </style>
</head>
<body>
    <script>console.log('‚úÖ HTML loaded');</script>
    
    <div class="container">
        <header class="header">
            <h1>üé™ Market Stall Tracker</h1>
            <div class="sync-indicator">
                <span class="sync-dot offline" id="syncStatus" style="background: #4caf50;"></span>
                <span id="syncText">Offline (iPad)</span>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-button active" data-tab="setup">Setup</button>
            <button class="tab-button" data-tab="products">Products</button>
            <button class="tab-button" data-tab="endOfDaySummary">üìã End-of-Day</button>
            <button class="tab-button" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="sales" style="display:none;">Sales</button>
        </nav>

        <!-- Setup Tab -->
        <section id="setup" class="tab-content active">
            <h2>Setup</h2>
            <div class="section-box">
                <h3>Team Name</h3>
                <input type="text" id="teamName" placeholder="Enter team name" value="Team 1">
                <button class="btn btn-primary" onclick="saveTeamName()">Save Team Name</button>
            </div>
            <div class="section-box">
                <h3>Team Members</h3>
                <div id="teamList" class="team-list"></div>
                <input type="text" id="newTeamMember" placeholder="Enter name">
                <button class="btn btn-primary" onclick="addTeamMember()">Add Member</button>
            </div>
            <div class="section-box">
                <h3>Shared Costs</h3>
                <label>Stall Fee (AUD)</label>
                <input type="number" id="stallFee" min="0" step="0.01" value="175">
                <label>Public Liability Insurance (AUD)</label>
                <input type="number" id="insurance" min="0" step="0.01" value="50">
                <label>Square Reader (AUD)</label>
                <input type="number" id="squareReader" min="0" step="0.01" value="50">
                <p><strong>Total Shared Costs: $<span id="totalCosts">275.00</span></strong></p>
                <button class="btn btn-primary" onclick="updateCosts()">Save Costs</button>
            </div>
            <div class="section-box">
                <h3>Utilities</h3>
                <button class="btn btn-primary" onclick="loadDemoData()">Load Demo Data</button>
                <button class="btn btn-danger" onclick="resetData()">Reset Data</button>
            </div>
        </section>

        <!-- Products Tab -->
        <section id="products" class="tab-content">
            <h2>Products (Inventory Setup)</h2>
            <div class="section-box">
                <h3>Add Product</h3>
                <input type="text" id="productName" placeholder="Product name">
                <input type="number" id="productPrice" placeholder="Price (optional)" min="0" step="0.01">
                <input type="number" id="productQuantityBrought" placeholder="Quantity Brought" min="0" step="1">
                <button class="btn btn-primary" onclick="addProduct()">Add Product</button>
            </div>
            <div class="section-box">
                <h3>Products List</h3>
                <div id="productsList"></div>
            </div>
        </section>

        <!-- End-of-Day Summary Tab -->
        <section id="endOfDaySummary" class="tab-content">
            <h2>End-of-Day Summary</h2>
            <div class="section-box">
                <h3>Final Revenue Totals</h3>
                <label>Cash Total (from cash box - float)</label>
                <input type="number" id="cashTotal" placeholder="0.00" min="0" step="0.01" value="0">
                <label>Card Total (from Square)</label>
                <input type="number" id="cardTotal" placeholder="0.00" min="0" step="0.01" value="0">
            </div>
            <div class="section-box">
                <h3>Stock Take: Quantity Left</h3>
                <div id="stockTakeList"></div>
            </div>
            <button class="btn btn-primary" onclick="submitStockTake()" style="margin: 20px;">‚úÖ Submit Stock Take & Complete Event</button>
        </section>

        <!-- Sales Tab -->
        <section id="sales" class="tab-content">
            <h2>Sales</h2>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="quick" onclick="switchSalesMode('quick')">‚ö° Quick Sale Mode</button>
                <button class="mode-btn" data-mode="detailed" onclick="switchSalesMode('detailed')">üìã Detailed Entry</button>
            </div>

            <!-- Quick Sale Mode -->
            <div id="quickSaleMode" class="sales-mode active">
                <div class="section-box">
                    <h3>Tap a Product to Sell</h3>
                    <div id="quickSaleButtons" class="quick-sale-grid"></div>
                </div>
                <div id="quantityModal" class="modal hidden">
                    <div class="modal-content">
                        <h3 id="quantityProductName">Product</h3>
                        <p>How many?</p>
                        <div class="qty-buttons">
                            <button class="btn btn-primary" onclick="setQtyAndAsk(1)">1</button>
                            <button class="btn btn-primary" onclick="setQtyAndAsk(2)">2</button>
                            <button class="btn btn-primary" onclick="setQtyAndAsk(3)">3</button>
                            <button class="btn btn-primary" onclick="setQtyAndAsk(5)">5</button>
                            <button class="btn btn-primary" onclick="setQtyAndAsk(10)">10</button>
                        </div>
                        <div style="margin-top: 15px;">
                            <label>Or enter qty:</label>
                            <input type="number" id="customQty" min="1" value="1" style="width: 60px;">
                            <button class="btn btn-primary" onclick="setQtyAndAsk(parseInt(document.getElementById('customQty').value))">Set</button>
                        </div>
                        <button class="btn btn-secondary" onclick="closeQuantityModal()">Cancel</button>
                    </div>
                </div>
                <div id="paymentModal" class="modal hidden">
                    <div class="modal-content">
                        <h3 id="paymentProductName">Product</h3>
                        <p>How was this paid?</p>
                        <button class="btn btn-primary" onclick="recordSale('Cash')">üíµ Cash</button>
                        <button class="btn btn-primary" onclick="recordSale('Card')">üí≥ Card</button>
                        <button class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                    </div>
                </div>
                <div class="section-box">
                    <h3>Running Totals</h3>
                    <p><strong>Total Revenue:</strong> $<span id="quickTotalRevenue">0.00</span></p>
                    <p><strong>Cash Sales:</strong> $<span id="quickCashTotal">0.00</span></p>
                    <p><strong>Card Sales:</strong> $<span id="quickCardTotal">0.00</span></p>
                </div>
                <div class="section-box">
                    <h3>Last Sale</h3>
                    <p id="lastSaleInfo">No sales yet</p>
                    <button class="btn btn-danger" onclick="undoLastSale()">‚Ü©Ô∏è Undo Last Sale</button>
                </div>
            </div>

            <!-- Detailed Entry Mode -->
            <div id="detailedSalesMode" class="sales-mode">
                <div class="section-box">
                    <h3>Record a Sale</h3>
                    <label>Product</label>
                    <select id="saleProductSelect" onchange="autoPopulatePrice()">
                        <option value="">-- Select a Product --</option>
                    </select>
                    <label>Quantity</label>
                    <input type="number" id="saleQuantity" min="1" value="1">
                    <label>Price per Unit (AUD)</label>
                    <input type="number" id="saleUnitPrice" min="0" step="0.01" placeholder="e.g., 15.00">
                    <label>Payment Method</label>
                    <select id="salePaymentMethod">
                        <option value="">-- Select --</option>
                        <option value="Cash">üíµ Cash</option>
                        <option value="Card">üí≥ Card</option>
                    </select>
                    <button class="btn btn-primary" onclick="addSaleDetailed()">Add Sale</button>
                </div>
                <div class="section-box">
                    <h3>Sales History</h3>
                    <div id="salesList"></div>
                </div>
            </div>
        </section>

        <!-- Dashboard Tab -->
        <section id="dashboard" class="tab-content">
            <h2>Dashboard</h2>
            <div class="section-box">
                <h3>Key Metrics</h3>
                <p><strong>Total Revenue:</strong> $<span id="dashRevenue">0.00</span></p>
                <p><strong>Total Shared Costs:</strong> $<span id="dashCosts">275.00</span></p>
                <p><strong>Profit After Costs:</strong> $<span id="dashProfit">0.00</span></p>
                <p><strong>Cash Sales:</strong> $<span id="dashCashTotal">0.00</span></p>
                <p><strong>Card Sales:</strong> $<span id="dashCardTotal">0.00</span></p>
                <p><strong>Total Units Sold:</strong> <span id="dashSaleCount">0</span></p>
            </div>
            <div class="section-box">
                <h4>Break-even Progress</h4>
                <div class="progress-container">
                    <div class="progress-bar" id="breakEvenBar" style="width: 0%"></div>
                </div>
                <p id="breakEvenText" style="margin-top: 8px; font-size: 0.9em; color: #666;">0% to break-even</p>
            </div>
            <div class="section-box">
                <h4>Profit Pot</h4>
                <p style="font-size: 1.3em; font-weight: bold; color: #4caf50;">Per-kid payout: $<span id="perKidPayout">0.00</span></p>
            </div>
            <div class="section-box">
                <h3>Product Leaderboard (by Units Sold)</h3>
                <div id="leaderboard"></div>
            </div>
            <div class="section-box">
                <button class="btn btn-primary" onclick="exportDashboardAsPDF()" style="width: 100%; padding: 15px; font-size: 16px;">üì• Download PDF Report</button>
            </div>
        </section>
    </div>

    <canvas id="confettiCanvas" class="confetti-canvas"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        console.log('‚úÖ Market Stall App (Offline Mode)');

        let appData = {
            teamName: 'Team 1',
            teamMembers: [],
            products: [],
            // POST-EVENT WORKFLOW: Replace sales array with inventory-based data
            sales: [],  // Kept for backward compatibility; used only for legacy data migration
            productsBrought: [],  // Array of {productId, quantityBrought}
            finalRevenue: {
                cash: 0,
                card: 0
            },
            stockTake: [],  // Array of {productId, quantityLeft}
            costs: {
                stallFee: 175,
                insurance: 50,
                squareReader: 50
            },
            reportMeta: {
                eventName: "Glenferrie Festival",
                eventDate: new Date().toISOString().split('T')[0],
                notes: ""
            },
            currentSalesMode: 'quick',
            pendingProductId: null,
            pendingQty: 1,
            pendingProductPrice: 0,
            previousProfit: 0,
            lastTopSellerId: null
        };

        // Local storage helpers
        function saveLocal() {
            try { localStorage.setItem('appData', JSON.stringify(appData)); } catch(e){}
        }

        // Compute product inventory metrics from stock take
        function computeInventoryMetrics() {
            const metrics = appData.products.map(p => {
                const brought = appData.productsBrought.find(x => x.productId == p.id);
                const stockTake = appData.stockTake.find(x => x.productId == p.id);
                const quantityBrought = brought ? brought.quantityBrought : 0;
                const quantityLeft = stockTake ? stockTake.quantityLeft : 0;
                const quantitySold = Math.max(0, quantityBrought - quantityLeft);
                const sellThrough = quantityBrought > 0 ? ((quantitySold / quantityBrought) * 100).toFixed(1) : 0;
                const revenue = quantitySold * (p.price || 0);
                return {
                    product: p,
                    quantityBrought,
                    quantityLeft,
                    quantitySold,
                    sellThrough,
                    revenue
                };
            });
            return metrics;
        }

        // Mini chart for dashboard
        function drawMiniSalesChart(productSales) {
            const canvas = document.getElementById('miniSalesChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const chartHeight = canvas.height;
            const chartWidth = canvas.width;
            ctx.clearRect(0, 0, chartWidth, chartHeight);
            if (!productSales || productSales.length === 0) return;
            const maxUnits = Math.max(...productSales.map(ps => ps.units), 1);
            const barWidth = chartWidth / (productSales.length * 1.6);
            const topMargin = 35;
            const bottomMargin = 25;
            const drawableHeight = chartHeight - topMargin - bottomMargin;
            productSales.forEach((ps, i) => {
                const barHeight = (ps.units / maxUnits) * drawableHeight;
                const x = i * (barWidth * 1.5) + 20;
                const y = topMargin + drawableHeight - barHeight;
                ctx.fillStyle = '#67d3b8';
                ctx.fillRect(x, y, barWidth, barHeight);
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.font = '10px Arial';
                ctx.fillText(ps.units.toString(), x + barWidth / 2, y - 8);
                ctx.fillText(ps.product.name, x + barWidth / 2, chartHeight - 5);
            });
        }

        // Confetti animation (simple)
        let _confettiRAF = null;
        let _confettiParticles = [];
        let _confettiRunning = false;
        function startConfetti() {
            const canvas = document.getElementById('confettiCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            _confettiParticles = [];
            for (let i = 0; i < 120; i++) {
                _confettiParticles.push({ x: Math.random()*canvas.width, y: Math.random()*-canvas.height, r: 4+Math.random()*6, vx: -1+Math.random()*2, vy: 2+Math.random()*4, c: `hsl(${Math.random()*360},80%,60%)` });
            }
            _confettiRunning = true;
            function loop() {
                if (!_confettiRunning) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
                ctx.clearRect(0,0,canvas.width,canvas.height);
                _confettiParticles.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.02;
                    if (p.y > canvas.height+20) { p.y = -10; p.x = Math.random()*canvas.width; p.vy = 2+Math.random()*4; }
                    ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, p.r, p.r*0.6);
                });
                _confettiRAF = requestAnimationFrame(loop);
            }
            loop();
        }
        function stopConfetti() {
            _confettiRunning = false;
            if (_confettiRAF) cancelAnimationFrame(_confettiRAF);
            _confettiRAF = null;
            // clear canvas immediately so confetti doesn't freeze on last frame
            const canvas = document.getElementById('confettiCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            _confettiParticles = [];
        }
        function loadLocal() {
            try {
                const j = localStorage.getItem('appData');
                if (j) {
                    const loaded = JSON.parse(j);
                    appData = loaded;
                }
            } catch(e){
                console.error('Error loading from localStorage:', e);
                localStorage.removeItem('appData'); // Clear corrupted data
            }
            // Ensure all required properties exist
            if (!appData.productsBrought) appData.productsBrought = [];
            if (!appData.finalRevenue) appData.finalRevenue = { cash: 0, card: 0 };
            if (!appData.stockTake) appData.stockTake = [];
            if (!appData.teamName) appData.teamName = 'Team 1';
            if (!appData.teamMembers) appData.teamMembers = [];
            if (!appData.products) appData.products = [];
            if (!appData.sales) appData.sales = [];
            if (!appData.costs) appData.costs = { stallFee: 175, insurance: 50, squareReader: 50 };
            if (!appData.reportMeta) appData.reportMeta = { eventName: 'Glenferrie Festival', eventDate: new Date().toISOString().split('T')[0], notes: '' };
            console.log('‚úÖ appData loaded and normalized:', appData);
        }

        // No Firebase helpers needed - localStorage only

        function updateSyncStatus() {
            const dot = document.getElementById('syncStatus');
            const text = document.getElementById('syncText');
            dot.classList.add('offline');
            dot.style.background = '#4caf50';
            text.textContent = 'Offline (iPad)';
        }

        // UI and data functions (mutate appData then save)
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            const el = document.getElementById(tabName);
            if (el) el.classList.add('active');
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if (btn) btn.classList.add('active');
            
            // Load stock take form when switching to end-of-day tab
            if (tabName === 'endOfDaySummary') {
                renderStockTakeForm();
            }
        }

        function addTeamMember() {
            const input = document.getElementById('newTeamMember');
            const name = input.value.trim();
            if (name) {
                appData.teamMembers.push(name);
                input.value = '';
                renderTeamList();
                saveLocal();
            }
        }

        function renderTeamList() {
            const list = document.getElementById('teamList');
            if (!list) return;
            list.innerHTML = appData.teamMembers.map((m, i) => 
                `<div class="team-member">${m} <button class="btn btn-danger" onclick="removeTeamMember(${i})">Remove</button></div>`
            ).join('');
        }

        function removeTeamMember(i) {
            appData.teamMembers.splice(i, 1);
            renderTeamList();
            saveLocal();
        }

        function addProduct() {
            try {
                console.log('‚úÖ addProduct called');
                const name = document.getElementById('productName').value.trim();
                const price = parseFloat(document.getElementById('productPrice').value) || 0;
                const quantityBrought = parseInt(document.getElementById('productQuantityBrought').value);
                
                console.log('Form values:', { name, price, quantityBrought });
                
                if (!name) {
                    alert('‚ùå Please enter a product name');
                    return;
                }
                if (!quantityBrought || quantityBrought < 1) {
                    alert('‚ùå Please enter quantity brought (must be at least 1)');
                    return;
                }
                
                // Defensive: ensure arrays exist
                if (!appData.products) appData.products = [];
                if (!appData.productsBrought) appData.productsBrought = [];
                
                const id = Date.now();
                appData.products.push({ id, name, price });
                appData.productsBrought.push({ productId: id, quantityBrought });
                
                console.log('‚úÖ Product saved to appData:', { id, name, price, quantityBrought });
                console.log('Products array:', appData.products);
                
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productQuantityBrought').value = '';
                console.log('‚úÖ Form cleared');
                
                saveLocal();
                console.log('‚úÖ Data saved to localStorage');
                
                try {
                    renderProducts();
                    console.log('‚úÖ renderProducts completed');
                } catch(e) {
                    console.error('‚ùå Error in renderProducts:', e);
                }
                
                try {
                    updateProductSelect();
                    console.log('‚úÖ updateProductSelect completed');
                } catch(e) {
                    console.error('‚ùå Error in updateProductSelect:', e);
                }
                
                try {
                    renderQuickSaleButtons();
                    console.log('‚úÖ renderQuickSaleButtons completed');
                } catch(e) {
                    console.error('‚ùå Error in renderQuickSaleButtons:', e);
                }
                
                alert(`‚úÖ ${name} added!`);
            } catch(e) {
                console.error('‚ùå Error in addProduct:', e);
                alert('Error adding product: ' + e.message);
            }
        }

        function renderProducts() {
            const list = document.getElementById('productsList');
            if (!list) return;
            list.innerHTML = appData.products.map(p => {
                const brought = appData.productsBrought.find(x => x.productId == p.id);
                const qty = brought ? brought.quantityBrought : 0;
                return `<div class="team-member">${p.name} (brought: ${qty}) ${p.price > 0 ? `- $${p.price.toFixed(2)}` : ''} <button class="btn btn-danger" onclick="removeProduct(${p.id})">Remove</button></div>`;
            }).join('');
        }

        function removeProduct(id) {
            appData.products = appData.products.filter(p => p.id !== id);
            appData.productsBrought = appData.productsBrought.filter(x => x.productId !== id);
            renderProducts(); updateProductSelect(); renderQuickSaleButtons();
            saveLocal();
        }

        function updateProductSelect() {
            const select = document.getElementById('saleProduct');
            const detailSelect = document.getElementById('saleProductSelect');
            if (!select && !detailSelect) return; // Elements might not exist (Sales tab hidden)
            const current = select?.value || detailSelect?.value;
            const html = '<option>Select product...</option>' + 
                appData.products.map(p => `<option value="${p.id}">${p.name} - $${p.price.toFixed(2)}</option>`).join('');
            if (select) select.innerHTML = html;
            if (detailSelect) detailSelect.innerHTML = '<option value="">-- Select a Product --</option>' + 
                appData.products.map(p => `<option value="${p.id}">${p.name} - $${p.price.toFixed(2)}</option>`).join('');
        }

        function renderQuickSaleButtons() {
            const grid = document.getElementById('quickSaleButtons');
            if (!grid) return; // Element might not exist (Sales tab hidden)
            grid.innerHTML = appData.products.map(p => 
                `<button class="product-btn" data-product-id="${p.id}" onclick="handleProductClick(this)">${p.name}<br>$${p.price.toFixed(2)}</button>`
            ).join('');
        }

        function handleProductClick(button) {
            const productId = parseInt(button.getAttribute('data-product-id'));
            const product = appData.products.find(p => p.id === productId);
            if (product) {
                openQuantityModal(product.id, product.name, product.price);
            }
        }

        function openQuantityModal(productId, productName, price) {
            appData.pendingProductId = productId;
            appData.pendingProductPrice = price;
            document.getElementById('quantityProductName').textContent = `${productName} - $${price.toFixed(2)}`;
            document.getElementById('quantityModal').classList.remove('hidden');
        }

        function openPaymentModal(productId, productName, price) {
            appData.pendingProductId = productId;
            appData.pendingProductPrice = price;
            document.getElementById('paymentProductName').textContent = `${productName} - $${price.toFixed(2)}`;
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        function closeQuantityModal() {
            document.getElementById('quantityModal').classList.add('hidden');
        }

        function setQtyAndAsk(qty) {
            appData.pendingQty = qty;
            console.log('Qty set to:', appData.pendingQty);
            closeQuantityModal();
            const product = appData.products.find(p => p.id == appData.pendingProductId);
            if (product) {
                console.log('Opening payment modal for:', product.name, 'qty:', qty, 'total:', qty * product.price);
                document.getElementById('paymentProductName').textContent = `${product.name} x${qty} = $${(qty * product.price).toFixed(2)}`;
                document.getElementById('paymentModal').classList.remove('hidden');
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            appData.pendingProductId = null;
            appData.pendingQty = 1;
        }

        function recordSale(paymentMethod) {
            if (!appData.pendingProductId) return;
            const product = appData.products.find(p => p.id == appData.pendingProductId);
            const qty = appData.pendingQty || 1;
            if (product) {
                appData.sales.push({ 
                    productId: appData.pendingProductId, 
                    qty: qty, 
                    price: product.price, 
                    amount: qty * product.price,
                    paymentMethod: paymentMethod
                });
                updateLastSaleInfo();
                renderSales(); updateDashboard();
                saveLocal();
                closePaymentModal();
            }
        }

        function updateLastSaleInfo() {
            const el = document.getElementById('lastSaleInfo');
            if (!el) return;
            if (appData.sales.length > 0) {
                const last = appData.sales[appData.sales.length - 1];
                const product = appData.products.find(p => p.id == last.productId);
                el.textContent = `${product?.name || 'Unknown'} x${last.qty} (${last.paymentMethod})`;
            } else {
                el.textContent = 'No sales yet';
            }
        }

        function autoPopulatePrice() {
            const productId = parseInt(document.getElementById('saleProductSelect').value);
            if (productId) {
                const product = appData.products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('saleUnitPrice').value = product.price.toFixed(2);
                }
            } else {
                document.getElementById('saleUnitPrice').value = '';
            }
        }

        function addSaleDetailed() {
            const productId = document.getElementById('saleProductSelect').value;
            const qty = parseInt(document.getElementById('saleQuantity').value);
            const unitPrice = parseFloat(document.getElementById('saleUnitPrice').value);
            const paymentMethod = document.getElementById('salePaymentMethod').value;
            if (productId && qty > 0 && unitPrice > 0 && paymentMethod) {
                appData.sales.push({ 
                    productId: parseInt(productId), 
                    qty, 
                    price: unitPrice, 
                    amount: qty * unitPrice,
                    paymentMethod: paymentMethod
                });
                document.getElementById('saleQuantity').value = '1';
                document.getElementById('saleUnitPrice').value = '';
                document.getElementById('saleProductSelect').value = '';
                document.getElementById('salePaymentMethod').value = '';
                renderSales(); updateDashboard();
                saveLocal();
            }
        }

        function adjustLastSaleQty(delta) {
            if (appData.sales.length > 0) {
                const last = appData.sales[appData.sales.length - 1];
                last.qty = Math.max(1, last.qty + delta);
                last.amount = last.qty * last.price;
                updateLastSaleInfo();
                renderSales(); updateDashboard();
                saveLocal();
            }
        }

        function undoLastSale() {
            if (appData.sales.length > 0) {
                appData.sales.pop();
                updateLastSaleInfo();
                renderSales(); updateDashboard();
                saveLocal();
            }
        }

        function renderSales() {
            const list = document.getElementById('salesList');
            if (!list) return;
            list.innerHTML = appData.sales.map((s, i) => {
                const product = appData.products.find(p => p.id == s.productId);
                return `<div class="team-member">${product?.name || 'Unknown'} x${s.qty} = $${s.amount.toFixed(2)} <button class="btn btn-danger" onclick="removeSale(${i})">Remove</button></div>`;
            }).join('');
        }

        function removeSale(i) {
            appData.sales.splice(i, 1);
            renderSales(); updateDashboard();
            saveLocal();
        }

        function updateDashboard() {
            // POST-EVENT: Use final revenue from end-of-day summary
            const revenue = appData.finalRevenue.cash + appData.finalRevenue.card;
            const costs = appData.costs.stallFee + appData.costs.insurance + appData.costs.squareReader;
            const profit = revenue - costs;
            const cashTotal = appData.finalRevenue.cash;
            const cardTotal = appData.finalRevenue.card;

            const rEl = document.getElementById('revenue');
            const cEl = document.getElementById('saleCount');
            const dashRev = document.getElementById('dashRevenue');
            const dashCosts = document.getElementById('dashCosts');
            const dashProfit = document.getElementById('dashProfit');
            const dashCash = document.getElementById('dashCashTotal');
            const dashCard = document.getElementById('dashCardTotal');
            const dashCount = document.getElementById('dashSaleCount');

            if (rEl) rEl.textContent = revenue.toFixed(2);
            if (dashRev) dashRev.textContent = revenue.toFixed(2);
            if (dashCosts) dashCosts.textContent = costs.toFixed(2);
            if (dashProfit) dashProfit.textContent = profit.toFixed(2);
            if (dashCash) dashCash.textContent = cashTotal.toFixed(2);
            if (dashCard) dashCard.textContent = cardTotal.toFixed(2);

            // Compute inventory metrics (quantity sold, sell-through, etc)
            const inventoryMetrics = computeInventoryMetrics();
            const totalUnitsSold = inventoryMetrics.reduce((sum, m) => sum + m.quantitySold, 0);
            console.log('Total Units Sold calculated:', totalUnitsSold, 'from metrics:', inventoryMetrics);
            if (cEl) {
                cEl.textContent = totalUnitsSold;
                console.log('Updated saleCount element:', totalUnitsSold);
            }
            if (dashCount) {
                dashCount.textContent = totalUnitsSold;
                console.log('Updated dashSaleCount element:', totalUnitsSold);
            } else {
                console.warn('dashSaleCount element not found!');
            }

            // Per-kid payout (can be negative if loss)
            const perKid = appData.teamMembers && appData.teamMembers.length > 0 ? (profit / appData.teamMembers.length) : 0;
            const perKidEl = document.getElementById('perKidPayout');
            if (perKidEl) {
                if (perKid < 0) {
                    perKidEl.textContent = `${Math.abs(perKid).toFixed(2)} loss per kid`;
                    perKidEl.style.color = '#f5576c';
                } else {
                    perKidEl.textContent = perKid.toFixed(2);
                    perKidEl.style.color = '#4caf50';
                }
            }

            // Calculate and display break-even progress
            let breakPct = 0;
            if (costs > 0) {
                breakPct = Math.max(0, Math.min(100, (revenue / costs) * 100));
            } else {
                breakPct = revenue > 0 ? 100 : 0;
            }
            const breakEvenBar = document.getElementById('breakEvenBar');
            const breakEvenText = document.getElementById('breakEvenText');
            if (breakEvenBar) breakEvenBar.style.width = breakPct + '%';
            if (breakEvenText) {
                if (breakPct >= 100) {
                    breakEvenText.textContent = `‚úÖ Reached break-even ‚Äî $${profit.toFixed(2)} profit`;
                } else {
                    const remaining = Math.max(0, costs - revenue);
                    breakEvenText.textContent = `${breakPct.toFixed(0)}% to break-even ‚Äî $${remaining.toFixed(2)} remaining`;
                }
            }

            // Render leaderboard
            renderLeaderboard(inventoryMetrics);

            // Update report in real-time
            updateReportDisplay();

            // Confetti when profit just goes positive
            if (typeof appData.previousProfit === 'undefined') appData.previousProfit = 0;
            if (appData.previousProfit <= 0 && profit > 0) {
                startConfetti();
                setTimeout(() => stopConfetti(), 6000);
            }
            appData.previousProfit = profit;
        }

        // Post-event: render leaderboard
        function renderLeaderboard(inventoryMetrics) {
            const leaderboard = document.getElementById('leaderboard');
            if (!leaderboard) return;
            
            // Sort by quantity sold descending
            const sorted = [...inventoryMetrics].sort((a, b) => b.quantitySold - a.quantitySold);
            
            let html = '<table style="width:100%; border-collapse: collapse;">';
            html += '<tr style="background:#f8f9fa; font-weight:bold;"><th style="padding:8px; text-align:left; border-bottom:2px solid #ddd;">Rank</th><th style="padding:8px; text-align:left; border-bottom:2px solid #ddd;">Product</th><th style="padding:8px; text-align:center; border-bottom:2px solid #ddd;">Sold</th><th style="padding:8px; text-align:center; border-bottom:2px solid #ddd;">Sell-Through</th><th style="padding:8px; text-align:right; border-bottom:2px solid #ddd;">Revenue</th></tr>';
            
            sorted.forEach((m, idx) => {
                const rank = idx + 1;
                const badgeHtml = rank === 1 ? ' ‚≠ê' : '';
                html += `<tr style="border-bottom:1px solid #ddd;">
                    <td style="padding:8px; font-weight:bold;">${rank}${badgeHtml}</td>
                    <td style="padding:8px;">${m.product.name}</td>
                    <td style="padding:8px; text-align:center;">${m.quantitySold}/${m.quantityBrought}</td>
                    <td style="padding:8px; text-align:center;">${m.sellThrough}%</td>
                    <td style="padding:8px; text-align:right;">$${m.revenue.toFixed(2)}</td>
                </tr>`;
            });
            html += '</table>';
            
            leaderboard.innerHTML = html;
        }

        function updateCosts() {
            appData.costs.stallFee = parseFloat(document.getElementById('stallFee').value) || 0;
            appData.costs.insurance = parseFloat(document.getElementById('insurance').value) || 0;
            appData.costs.squareReader = parseFloat(document.getElementById('squareReader').value) || 0;
            const total = appData.costs.stallFee + appData.costs.insurance + appData.costs.squareReader;
            const totalEl = document.getElementById('totalCosts');
            if (totalEl) totalEl.textContent = total.toFixed(2);
            updateDashboard();
            saveLocal();
        }

        // Post-event: render stock take form
        function renderStockTakeForm() {
            const list = document.getElementById('stockTakeList');
            if (!list) return;
            list.innerHTML = appData.products.map(p => {
                const brought = appData.productsBrought.find(x => x.productId == p.id);
                const stockTake = appData.stockTake.find(x => x.productId == p.id);
                const quantityBrought = brought ? brought.quantityBrought : 0;
                const quantityLeft = stockTake ? stockTake.quantityLeft : 0;
                return `
                    <div class="section-box" style="margin-bottom: 10px;">
                        <p><strong>${p.name}</strong> - Brought: ${quantityBrought}</p>
                        <label>Quantity Left:</label>
                        <input type="number" data-product-id="${p.id}" class="stock-left-input" value="${quantityLeft}" min="0" step="1" max="${quantityBrought}">
                    </div>
                `;
            }).join('');
        }

        // Post-event: submit stock take
        function submitStockTake() {
            const cashVal = parseFloat(document.getElementById('cashTotal').value) || 0;
            const cardVal = parseFloat(document.getElementById('cardTotal').value) || 0;
            
            if (cashVal < 0 || cardVal < 0) {
                alert('Revenue totals cannot be negative');
                return;
            }
            
            // Capture stock take inputs
            appData.stockTake = [];
            document.querySelectorAll('.stock-left-input').forEach(input => {
                const productId = parseInt(input.getAttribute('data-product-id'));
                const quantityLeft = parseInt(input.value) || 0;
                appData.stockTake.push({ productId, quantityLeft });
            });
            
            // Save final revenue
            appData.finalRevenue.cash = cashVal;
            appData.finalRevenue.card = cardVal;
            
            saveLocal();
            updateDashboard();
            showNotification('‚úÖ Stock take submitted! Event complete.');
            switchTab('dashboard');
        }

        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.animation = 'slideOut 300ms ease forwards';
                setTimeout(() => notif.remove(), 300);
            }, 2000);
        }

        function saveTeamName() {
            appData.teamName = document.getElementById('teamName').value.trim();
            if (appData.teamName) {
                saveLocal();
                showNotification('‚úÖ Team name saved!');
            }
        }

        function saveReportMeta() {
            appData.reportMeta.eventName = document.getElementById('eventName').value;
            appData.reportMeta.eventDate = document.getElementById('eventDate').value;
            appData.reportMeta.notes = document.getElementById('eventNotes').value;
            updateReportDisplay();
            saveLocal();
            // Show visual feedback
            showNotification('‚úÖ Report details saved!');
        }

        function updateReportDisplay() {
            // No longer needed - Reports tab is now just PDF export
        }

        function exportDashboardAsPDF() {
            try {
                console.log('üîÑ Starting PDF export...');
                const { jsPDF } = window.jspdf;
                console.log('‚úÖ jsPDF loaded:', !!jsPDF);
                
                const doc = new jsPDF('p', 'mm', 'a4');
                let yPos = 12;
                const pageHeight = doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 12;
                const lineHeight = 6;

                // Calculate metrics
                console.log('üìä Calculating metrics...');
                const revenue = appData.finalRevenue.cash + appData.finalRevenue.card;
                const costs = appData.costs.stallFee + appData.costs.insurance + appData.costs.squareReader;
                const profit = revenue - costs;
                const breakPct = costs > 0 ? Math.max(0, Math.min(100, (revenue / costs) * 100)) : (revenue > 0 ? 100 : 0);
                const perKid = appData.teamMembers && appData.teamMembers.length > 0 ? (profit / appData.teamMembers.length) : 0;
                const inventoryMetrics = computeInventoryMetrics();
                const totalUnitsSold = inventoryMetrics.reduce((sum, m) => sum + m.quantitySold, 0);
                const today = new Date().toISOString().split('T')[0];

                // Header with background color
                doc.setDrawColor(102, 126, 234);
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 22, 'F');
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Market Stall Report', margin, 10);
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`${appData.teamName}`, margin, 17);
                
                yPos = 28;
                doc.setTextColor(0, 0, 0);
                
                // Team info
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('TEAM INFORMATION', margin, yPos);
                yPos += 5;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const teamMembersList = appData.teamMembers && appData.teamMembers.length > 0 ? appData.teamMembers.join(', ') : 'None';
                doc.text(`Members: ${teamMembersList}`, margin + 2, yPos);
                yPos += lineHeight;
                doc.text(`Date: ${today}`, margin + 2, yPos);
                yPos += 10;
                
                // Key Metrics
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('KEY METRICS', margin, yPos);
                yPos += 5;
                
                const metrics = [
                    { label: 'Total Revenue', value: `$${revenue.toFixed(2)}`, color: [102, 126, 234] },
                    { label: 'Total Costs', value: `$${costs.toFixed(2)}`, color: [255, 152, 0] },
                    { label: 'Net Profit', value: `$${profit.toFixed(2)}`, color: profit >= 0 ? [76, 175, 80] : [245, 87, 108] },
                    { label: 'Units Sold', value: `${totalUnitsSold}`, color: [102, 126, 234] },
                    { label: 'Break-even %', value: `${breakPct.toFixed(0)}%`, color: [102, 126, 234] },
                    { label: 'Per-Kid Payout', value: `$${perKid.toFixed(2)}`, color: perKid >= 0 ? [76, 175, 80] : [245, 87, 108] }
                ];
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                metrics.forEach(m => {
                    doc.setTextColor(m.color[0], m.color[1], m.color[2]);
                    doc.setFont(undefined, 'bold');
                    doc.text(m.label, margin + 2, yPos);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    doc.text(m.value, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += lineHeight;
                });
                
                yPos += 5;
                
                // Break-even Progress Bar
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('BREAK-EVEN PROGRESS', margin, yPos);
                yPos += 5;
                
                // Draw bar background
                doc.setDrawColor(200, 200, 200);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPos, pageWidth - margin * 2, 8, 'FD');
                
                // Draw progress fill
                const fillWidth = ((pageWidth - margin * 2) * breakPct) / 100;
                doc.setFillColor(76, 175, 80);
                doc.rect(margin, yPos, fillWidth, 8, 'F');
                
                // Progress label
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                const progressLabel = breakPct >= 100 ? `‚úÖ ${breakPct.toFixed(0)}%` : `${breakPct.toFixed(0)}%`;
                doc.text(progressLabel, margin + 2, yPos + 5.5);
                
                yPos += 12;
                
                // Product Leaderboard
                if (inventoryMetrics.length > 0 && yPos < pageHeight - 45) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('PRODUCT LEADERBOARD', margin, yPos);
                    yPos += 6;
                    
                    // Table header
                    doc.setFillColor(220, 220, 220);
                    doc.rect(margin, yPos - 4, pageWidth - margin * 2, 5, 'F');
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text('Rank', margin + 1, yPos);
                    doc.text('Product', margin + 8, yPos);
                    doc.text('Sold', margin + 55, yPos);
                    doc.text('S-Through %', margin + 75, yPos);
                    doc.text('Revenue', pageWidth - margin - 15, yPos, { align: 'right' });
                    yPos += 6;
                    
                    // Table rows
                    const sorted = [...inventoryMetrics].sort((a, b) => b.quantitySold - a.quantitySold);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    
                    sorted.forEach((m, idx) => {
                        if (yPos > pageHeight - 12) {
                            doc.addPage();
                            yPos = margin;
                        }
                        
                        // Alternate row color
                        if (idx % 2 === 1) {
                            doc.setFillColor(248, 248, 248);
                            doc.rect(margin, yPos - 4, pageWidth - margin * 2, 5, 'F');
                        }
                        
                        const rank = idx === 0 ? '‚≠ê' : `${idx + 1}`;
                        const sold = `${m.quantitySold}/${m.quantityBrought}`;
                        const sellThrough = `${m.sellThrough}%`;
                        const revStr = `$${m.revenue.toFixed(2)}`;
                        
                        doc.text(rank, margin + 1, yPos);
                        doc.text(m.product.name.substring(0, 15), margin + 8, yPos);
                        doc.text(sold, margin + 55, yPos);
                        doc.text(sellThrough, margin + 75, yPos);
                        doc.text(revStr, pageWidth - margin - 15, yPos, { align: 'right' });
                        yPos += 5;
                    });
                }
                
                // Save PDF
                const filename = `Market_Stall_Report_${appData.teamName.replace(/\s+/g, '_')}_${today}.pdf`;
                console.log('üíæ Saving PDF as:', filename);
                doc.save(filename);
                console.log('‚úÖ PDF export complete!');
            } catch (error) {
                console.error('‚ùå PDF export error:', error);
                alert('Error exporting PDF: ' + error.message);
            }
        }
            doc.setFont(undefined, 'bold');
            doc.text('KEY METRICS', margin, yPos);
            yPos += 6;
            
            // Metrics boxes
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            const metrics = [
                { label: 'Total Revenue', value: `$${revenue.toFixed(2)}` },
                { label: '  Cash', value: `$${appData.finalRevenue.cash.toFixed(2)}` },
                { label: '  Card', value: `$${appData.finalRevenue.card.toFixed(2)}` },
                { label: 'Total Costs', value: `$${costs.toFixed(2)}` },
                { label: 'Net Profit', value: `$${profit.toFixed(2)}` },
                { label: 'Units Sold', value: `${totalUnitsSold}` },
                { label: 'Break-even', value: `${breakPct.toFixed(0)}%` },
                { label: 'Per-Kid Payout', value: `$${perKid.toFixed(2)}` },
            ];
            
            metrics.forEach((m, idx) => {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = margin;
                }
                doc.setFont(undefined, 'bold');
                doc.text(m.label, margin + 2, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(m.value, pageWidth - margin - 15, yPos, { align: 'right' });
                yPos += lineHeight;
            });
            
            yPos += 5;
            
            // Break-even Progress Bar
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('BREAK-EVEN PROGRESS', margin, yPos);
            yPos += 5;
            
            // Draw bar background
            doc.setDrawColor(200, 200, 200);
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, yPos, pageWidth - margin * 2, 8, 'FD');
            
            // Draw progress fill
            const fillWidth = ((pageWidth - margin * 2) * breakPct) / 100;
            doc.setFillColor(76, 175, 80);
            doc.rect(margin, yPos, fillWidth, 8, 'F');
            
            // Progress label
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            const progressLabel = breakPct >= 100 ? `‚úÖ ${breakPct.toFixed(0)}%` : `${breakPct.toFixed(0)}%`;
            doc.text(progressLabel, margin + 2, yPos + 5.5);
            
            yPos += 12;
            
            // Product Leaderboard
            if (inventoryMetrics.length > 0 && yPos < pageHeight - 45) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('PRODUCT LEADERBOARD', margin, yPos);
                yPos += 6;
                
                // Table header
                doc.setFillColor(220, 220, 220);
                doc.rect(margin, yPos - 4, pageWidth - margin * 2, 5, 'F');
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('Rank', margin + 1, yPos);
                doc.text('Product', margin + 8, yPos);
                doc.text('Sold', margin + 55, yPos);
                doc.text('S-Through %', margin + 75, yPos);
                doc.text('Revenue', pageWidth - margin - 15, yPos, { align: 'right' });
                yPos += 6;
                
                // Table rows
                const sorted = [...inventoryMetrics].sort((a, b) => b.quantitySold - a.quantitySold);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                
                sorted.forEach((m, idx) => {
                    if (yPos > pageHeight - 12) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    // Alternate row color
                    if (idx % 2 === 1) {
                        doc.setFillColor(248, 248, 248);
                        doc.rect(margin, yPos - 4, pageWidth - margin * 2, 5, 'F');
                    }
                    
                    const rank = idx === 0 ? '‚≠ê' : `${idx + 1}`;
                    const sold = `${m.quantitySold}/${m.quantityBrought}`;
                    const sellThrough = `${m.sellThrough}%`;
                    const revStr = `$${m.revenue.toFixed(2)}`;
                    
                    doc.text(rank, margin + 1, yPos);
                    doc.text(m.product.name.substring(0, 15), margin + 8, yPos);
                    doc.text(sold, margin + 55, yPos);
                    doc.text(sellThrough, margin + 75, yPos);
                    doc.text(revStr, pageWidth - margin - 15, yPos, { align: 'right' });
                    yPos += 5;
                });
            }
            
            // Save PDF
            const filename = `Market_Stall_Report_${appData.teamName.replace(/\s+/g, '_')}_${today}.pdf`;
            doc.save(filename);
        }

        function loadDemoData() {
            appData.teamMembers = ['Alice', 'Bob', 'Charlie'];
            appData.products = [
                { id: 1, name: 'Dragon', price: 15 },
                { id: 2, name: 'Spinner', price: 8 },
                { id: 3, name: 'Stand', price: 12 }
            ];
            // Post-event demo: set up inventory
            appData.productsBrought = [
                { productId: 1, quantityBrought: 20 },
                { productId: 2, quantityBrought: 30 },
                { productId: 3, quantityBrought: 25 }
            ];
            // Demo stock take results
            appData.stockTake = [
                { productId: 1, quantityLeft: 2 },   // 18 sold
                { productId: 2, quantityLeft: 5 },   // 25 sold
                { productId: 3, quantityLeft: 8 }    // 17 sold
            ];
            // Demo final revenue
            appData.finalRevenue = { cash: 300, card: 200 };
            
            appData.costs = { stallFee: 175, insurance: 50, squareReader: 50 };
            appData.reportMeta = {
                eventName: "Glenferrie Festival",
                eventDate: new Date().toISOString().split('T')[0],
                notes: "Demo data loaded"
            };
            renderAll();
            saveLocal();
        }

        function renderAll() {
            // Ensure all required properties exist before rendering
            if (!appData.productsBrought) appData.productsBrought = [];
            if (!appData.finalRevenue) appData.finalRevenue = { cash: 0, card: 0 };
            if (!appData.stockTake) appData.stockTake = [];
            if (!appData.costs) appData.costs = { stallFee: 175, insurance: 50, squareReader: 50 };
            if (!appData.reportMeta) appData.reportMeta = { eventName: 'Glenferrie Festival', eventDate: new Date().toISOString().split('T')[0], notes: '' };
            if (!appData.teamMembers) appData.teamMembers = [];
            if (!appData.products) appData.products = [];
            if (!appData.sales) appData.sales = [];
            
            renderTeamList(); renderProducts(); updateProductSelect(); renderSales(); updateDashboard();
            renderQuickSaleButtons(); renderStockTakeForm();
            // Initialize cost inputs
            document.getElementById('stallFee').value = appData.costs.stallFee;
            document.getElementById('insurance').value = appData.costs.insurance;
            document.getElementById('squareReader').value = appData.costs.squareReader;
            updateCosts();
            // Initialize report section
            document.getElementById('eventName').value = appData.reportMeta.eventName;
            document.getElementById('eventDate').value = appData.reportMeta.eventDate;
            document.getElementById('eventNotes').value = appData.reportMeta.notes;
            // Initialize end-of-day summary
            document.getElementById('cashTotal').value = appData.finalRevenue.cash;
            document.getElementById('cardTotal').value = appData.finalRevenue.card;
            updateReportDisplay();
        }

        function resetData() {
            if (confirm('Reset all data?')) {
                appData = { 
                    teamName: 'Team 1',
                    teamMembers: [], 
                    products: [], 
                    sales: [], 
                    productsBrought: [],
                    finalRevenue: { cash: 0, card: 0 },
                    stockTake: [],
                    costs: { stallFee: 175, insurance: 50, squareReader: 50 }, 
                    reportMeta: { eventName: 'Glenferrie Festival', eventDate: new Date().toISOString().split('T')[0], notes: '' }, 
                    currentSalesMode: 'quick', 
                    pendingProductId: null 
                };
                renderAll();
                saveLocal();
            }
        }

        // Setup event listeners
        console.log('Setting up event listeners...');
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                switchTab(e.target.getAttribute('data-tab'));
            });
        });

        // Initialize: load from localStorage
        console.log('Initializing app...');
        loadLocal();
        renderAll();
        updateSyncStatus();
        // TEMP: auto-load demo data for preview. Remove this line when finished testing.
        // loadDemoData(); renderAll(); updateDashboard(); updateReportDisplay();
        console.log('‚úÖ App ready (Offline Mode)! Demo data loaded');
    </script>
</body>
</html>
